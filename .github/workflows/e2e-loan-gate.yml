name: API Automation Workflow

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  BLOCK_SEVERITIES: blocker,critical,sev1,p0

jobs:
  api-automation-tests:
    runs-on: ubuntu-latest

    steps:
      # Repo A (client repo)
      - name: Checkout client repo (Repo A)
        uses: actions/checkout@v4

      # Repo B (automation repo)
      - name: Checkout API automation repo (Repo B)
        uses: actions/checkout@v4
        with:
          repository: ShaikSuhailAhmed/autochek-api-e2e-loan-automation
          token: ${{ secrets.E2E_AUTOMATION_TOKEN }}
          path: automation

      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          java-version: "22"
          distribution: "temurin"
          cache: maven

      # ðŸš¨ IMPORTANT: run Maven INSIDE Repo B
      - name: Run API Tests
        id: run_tests
        continue-on-error: true
        working-directory: automation
        run: |
          mvn -B clean test \
            -DsuiteXmlFile=testng.xml \
            -Dallure.results.directory=target/allure-results

      - name: Verify Allure results exist
        run: |
          COUNT=$(find automation/target/allure-results -name "*.json" | wc -l | tr -d ' ')
          if [ "$COUNT" -eq 0 ]; then
            echo "::error::No Allure results generated"
            exit 1
          fi

      - name: Generate Allure Report
        run: |
          npm install -g allure-commandline
          allure generate automation/target/allure-results \
            -o automation/target/allure-report --clean

      - name: Publish Allure report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: automation/target/allure-report
          keep_files: true

      # ðŸ”’ SEVERITY-BASED PR GATE
      - name: Gate PR on blocking severities
        if: always()
        run: |
          sudo apt-get install -y jq >/dev/null 2>&1 || true

          jq -r --arg block "${BLOCK_SEVERITIES}" '
            ( $block | split(",") ) as $sevlist
            |
            select(.status=="failed" or .status=="broken")
            |
            (.labels // [] 
              | map(select(.name=="severity") | .value | ascii_downcase)
              | .[0] // "unknown") as $sev
            |
            select( ($sevlist | index($sev)) != null )
            |
            [ $sev, .status, (.name // .fullName // "unknown") ] | @tsv
          ' automation/target/allure-results/*.json | tee blocked.tsv || true

          BLOCK_COUNT=$(wc -l < blocked.tsv | tr -d ' ')

          if [ "${{ github.event_name }}" = "pull_request" ] && [ "$BLOCK_COUNT" -gt 0 ]; then
            echo "::error::Blocking API failures found ($BLOCK_COUNT). PR will not merge."
            exit 1
          fi
