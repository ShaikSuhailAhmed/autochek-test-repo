name: E2E API Automation Workflow

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  BLOCK_SEVERITIES: blocker,critical,sev1,p0

jobs:
  api-automation-tests:
    runs-on: ubuntu-latest

    steps:
      # Repo A (client)
      - name: Checkout client repo
        uses: actions/checkout@v4

      # Repo B (E2E automation)
      - name: Checkout E2E automation repo
        uses: actions/checkout@v4
        with:
          repository: ShaikSuhailAhmed/autochek-api-e2e-loan-automation
          token: ${{ secrets.E2E_AUTOMATION_TOKEN }}
          path: e2e

      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'temurin'
          cache: maven

      - name: Run E2E API Tests
        working-directory: e2e
        run: mvn -B clean test -DsuiteXmlFile=testng.xml -Dallure.results.directory=target/allure-results

      # --- Pull previous gh-pages for history ---
      - name: Checkout gh-pages (if exists)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: ghp
        continue-on-error: true

      - name: Restore Allure history
        run: |
          mkdir -p e2e/target/allure-results/history
          if [ -d "ghp/latest/history" ]; then
            cp -r ghp/latest/history/* e2e/target/allure-results/history/ || true
          fi

      - name: Generate Allure Report
        working-directory: e2e
        run: |
          npm install -g allure-commandline
          allure generate target/allure-results -o target/allure-report --clean

      # --- Prepare gh-pages ---
      - name: Prepare gh-pages content
        run: |
          TS=$(date -u +"%Y-%m-%d_%H-%M-%S")
          DEST="${TS}_pr-${{ github.event.pull_request.number }}_${GITHUB_SHA::7}"

          mkdir -p ghp/$DEST
          mkdir -p ghp/latest

          cp -r e2e/target/allure-report/* ghp/$DEST/
          cp -r e2e/target/allure-report/* ghp/latest/

          if [ ! -f ghp/.nojekyll ]; then echo > ghp/.nojekyll; fi

          {
            echo "<!doctype html><html><head><meta charset='utf-8'>"
            echo "<title>Allure Reports</title></head><body>"
            echo "<h1>Allure Reports</h1>"
            echo "<p><b>Latest:</b> <a href='./latest/'>Open</a></p>"
            echo "<h2>All Runs</h2><ul>"
            find ghp -maxdepth 1 -type d | sed 's|ghp/||' | grep -vE 'latest|\.git' | sort -r | while read d; do
              echo "<li><a href='./$d/'>$d</a></li>"
            done
            echo "</ul></body></html>"
          } > ghp/index.html

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ghp
          keep_files: true

      # --- Summary (ROOT link, not /latest) ---
      - name: Post Allure link to Summary
        run: |
          BASE="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          {
            echo "### Allure Report"
            echo ""
            echo "[Open report index](${BASE}/)"
          } >> $GITHUB_STEP_SUMMARY

      # --- Severity-based PR gating ---
      - name: Gate PR on severe failures
        if: always()
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq || true
          jq -r --arg block "${BLOCK_SEVERITIES}" '
            ($block | split(",")) as $sev |
            select(.status=="failed" or .status=="broken") |
            (.labels[]? | select(.name=="severity") | .value) as $s |
            select($sev | index($s)) |
            [$s, .status, .name] | @tsv
          ' e2e/target/allure-results/*.json > blocked.tsv || true

          COUNT=$(wc -l < blocked.tsv)
          if [ "$COUNT" -gt 0 ]; then
            echo "::error::Severe failures detected. Blocking PR."
            exit 1
          fi
