name: E2E API Automation Workflow

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  BLOCK_SEVERITIES: blocker,critical,sev1,p0

jobs:
  api-automation-tests:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout client repo (Repo A) ---
      - name: Checkout client repo
        uses: actions/checkout@v4

      # --- Checkout E2E automation repo (Repo B) ---
      - name: Checkout E2E automation repo
        uses: actions/checkout@v4
        with:
          repository: ShaikSuhailAhmed/autochek-api-e2e-loan-automation
          token: ${{ secrets.E2E_AUTOMATION_TOKEN }}
          path: e2e

      # --- Java setup ---
      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'temurin'
          cache: maven

      # --- Run E2E API Tests (FIXED COMMAND) ---
      - name: Run E2E API Tests
        working-directory: e2e
        run: mvn -B clean test -DsuiteXmlFile=testng.xml -Dallure.results.directory=target/allure-results

      # --- Verify Allure results exist ---
      - name: Verify Allure results exist
        id: verify
        working-directory: e2e
        run: |
          RESULT_COUNT=$(find target/allure-results -type f -name "*.json" -not -path "*/history/*" 2>/dev/null | wc -l | tr -d ' ')
          echo "count=$RESULT_COUNT" >> $GITHUB_OUTPUT
          if [ "$RESULT_COUNT" -eq 0 ]; then
            echo "::error::No Allure test results were produced."
            exit 1
          fi

      # --- Checkout gh-pages (for history) ---
      - name: Checkout gh-pages (if exists)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: ghp
        continue-on-error: true

      # --- Restore Allure history ---
      - name: Restore Allure history
        working-directory: e2e
        run: |
          mkdir -p target/allure-results/history
          if [ -d "../ghp/latest/history" ]; then
            cp -r ../ghp/latest/history/* target/allure-results/history/ || true
          fi

      # --- Generate Allure Report ---
      - name: Generate Allure Report
        working-directory: e2e
        run: |
          npm install -g allure-commandline
          allure generate target/allure-results -o target/allure-report --clean

      # --- Prepare gh-pages content (latest + history + index) ---
      - name: Prepare gh-pages content
        run: |
          mkdir -p ghp/latest
          cp -r e2e/target/allure-report/* ghp/latest/

          if [ ! -f ghp/.nojekyll ]; then echo > ghp/.nojekyll; fi

          {
            echo "<!doctype html><html><head><meta charset='utf-8'>"
            echo "<title>Allure Reports</title>"
            echo "<style>body{font-family:system-ui,Arial}</style>"
            echo "</head><body>"
            echo "<h1>Allure Reports</h1>"
            echo "<p><a href='./latest/'>Open Latest Report</a></p>"
            echo "</body></html>"
          } > ghp/index.html

      # --- Publish to GitHub Pages ---
      - name: Publish Allure report to GitHub Pages
        if: steps.verify.outputs.count != '0'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ghp
          keep_files: true
          force_orphan: false

      # --- Post report link to workflow summary ---
      - name: Post report link to Summary
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          echo "### Allure Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— https://${OWNER}.github.io/${REPO}/latest/" >> $GITHUB_STEP_SUMMARY

      # --- Gate PR on severe failures ---
      - name: Gate PR on blocking severities
        if: always()
        working-directory: e2e
        run: |
          sudo apt-get update >/dev/null 2>&1
          sudo apt-get install -y jq >/dev/null 2>&1

          jq -r --arg block "${BLOCK_SEVERITIES}" '
            ( $block | ascii_downcase | split(",") ) as $sevlist
            |
            select(.status=="failed" or .status=="broken")
            |
            (.labels // [] | map(select(.name=="severity") | .value | ascii_downcase) | .[0] // "unknown") as $sev
            |
            select( ($sevlist | index($sev)) != null )
            |
            [ $sev, .status, (.name // .fullName // "unknown") ] | @tsv
          ' target/allure-results/*.json 2>/dev/null | tee .blocked.tsv

          BLOCK_COUNT=$(wc -l < .blocked.tsv | tr -d ' ')

          if [ "${{ github.event_name }}" = "pull_request" ] && [ "$BLOCK_COUNT" -gt 0 ]; then
            echo "::error::Severe test failures detected ($BLOCK_COUNT). Blocking PR."
            exit 1
          fi
