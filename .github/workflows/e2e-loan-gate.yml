name: E2E API + UI Automation Workflow

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  API_BLOCK_SEVERITIES: blocker,critical,sev1,p0
  UI_BLOCK_SEVERITIES: blocker,critical
  AUTOMATION_REPO: ShaikSuhailAhmed/autochek-api-e2e-loan-automation

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      # =========================================================
      # Checkout automation repo
      # =========================================================
      - name: Checkout E2E automation repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.AUTOMATION_REPO }}
          token: ${{ secrets.E2E_AUTOMATION_TOKEN }}
          path: e2e

      # =========================================================
      # Setup Java
      # =========================================================
      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'temurin'
          cache: maven

      # =========================================================
      # Run API Tests
      # =========================================================
      - name: Run API E2E Tests
        working-directory: e2e/api-automation
        continue-on-error: true
        run: |
          mvn -B clean test \
            -DsuiteXmlFile=testng-api.xml \
            -Dallure.results.directory=target/allure-results

      # =========================================================
      # Run UI Tests
      # =========================================================
      - name: Run UI E2E Tests
        working-directory: e2e/ui-automation
        continue-on-error: true
        run: |
          mvn -B clean test \
            -DsuiteXmlFile=testng-ui.xml \
            -Dallure.results.directory=target/allure-results

      # =========================================================
      # Verify Allure results (API + UI)
      # =========================================================
      - name: Verify Allure results exist
        id: verify
        run: |
          API_COUNT=$(find e2e/api-automation/target/allure-results -name "*.json" -not -path "*/history/*" | wc -l)
          UI_COUNT=$(find e2e/ui-automation/target/allure-results -name "*.json" -not -path "*/history/*" | wc -l)

          echo "api_count=$API_COUNT" >> $GITHUB_OUTPUT
          echo "ui_count=$UI_COUNT" >> $GITHUB_OUTPUT

          if [ "$API_COUNT" -eq 0 ] || [ "$UI_COUNT" -eq 0 ]; then
            echo "::error::Allure results missing"
            exit 1
          fi

      # =========================================================
      # Checkout gh-pages
      # =========================================================
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: ghp
        continue-on-error: true

      # =========================================================
      # Restore Allure history (For Trend Charts)
      # =========================================================
      - name: Restore Allure history
        run: |
          mkdir -p e2e/api-automation/target/allure-results/history
          mkdir -p e2e/ui-automation/target/allure-results/history

          cp -r ghp/latest/api/history/* e2e/api-automation/target/allure-results/history/ 2>/dev/null || true
          cp -r ghp/latest/ui/history/* e2e/ui-automation/target/allure-results/history/  2>/dev/null || true

      # =========================================================
      # Generate Allure reports
      # =========================================================
      - name: Generate Allure reports
        run: |
          npm install -g allure-commandline
          allure generate e2e/api-automation/target/allure-results -o e2e/api-automation/target/allure-report --clean
          allure generate e2e/ui-automation/target/allure-results  -o e2e/ui-automation/target/allure-report --clean

      # =========================================================
      # Compute archive directory
      # =========================================================
      - name: Compute archive directory
        id: meta
        run: |
          TS=$(date -u +"%Y-%m-%d_%H-%M-%S")
          SHORT_SHA=${GITHUB_SHA::7}
          DEST="${TS}_${SHORT_SHA}"
          echo "dest_dir=$DEST" >> $GITHUB_OUTPUT

      # =========================================================
      # Prepare gh-pages content (The Fix is Here)
      # =========================================================
      - name: Prepare gh-pages content
        run: |
          DEST="${{ steps.meta.outputs.dest_dir }}"
          
          # Force clean creation of current run folders
          mkdir -p ghp/${DEST}/api ghp/${DEST}/ui
          mkdir -p ghp/latest/api ghp/latest/ui
      
          # Copy reports to timestamped and 'latest' locations
          cp -r e2e/api-automation/target/allure-report/* ghp/${DEST}/api/
          cp -r e2e/ui-automation/target/allure-report/* ghp/${DEST}/ui/
      
          cp -r e2e/api-automation/target/allure-report/* ghp/latest/api/
          cp -r e2e/ui-automation/target/allure-report/* ghp/latest/ui/
      
          # Generate Dynamic HTML Dashboard
          cat <<EOF > ghp/index.html
          <!doctype html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Test Automation History</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; line-height: 1.5; padding: 40px; color: #24292e; max-width: 900px; margin: auto; }
              h1 { border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
              .section { margin-bottom: 30px; }
              .run-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f6f8fa; }
              .run-date { flex: 1; font-family: monospace; font-weight: bold; }
              .run-links a { margin-left: 15px; text-decoration: none; color: #0366d6; font-weight: 500; }
              .run-links a:hover { text-decoration: underline; }
              .latest-box { background: #f6f8fa; padding: 20px; border-radius: 6px; border: 1px solid #d1d5da; }
            </style>
          </head>
          <body>
            <h1>End to End Test Automation Dashboard</h1>
            
            <div class="section latest-box">
              <h2>ðŸš€ Latest Run</h2>
              <div class="run-links">
                <a href="./latest/api/">View E2E API Report</a>
                <a href="./latest/ui/">View E2E UI Report</a>
              </div>
            </div>

            <div class="section">
              <h2>ðŸ“… All Historical E2E Runs</h2>
              <div id="runs">
              $(for run in $(ls -1 ghp | grep -E '^[0-9]{4}-[0-9]{2}-[0-9]{2}_[0-9]{2}-[0-9]{2}-[0-9]{2}' | sort -r); do
                  echo "<div class='run-item'>"
                  echo "  <div class='run-date'>$(echo $run | sed 's/_/ /')</div>"
                  echo "  <div class='run-links'>"
                  
                  # Logic to handle both structured and unstructured legacy folders
                  if [ -d "ghp/$run/api" ]; then
                    echo "<a href='./$run/api/'>API</a>"
                  fi
                  if [ -d "ghp/$run/ui" ]; then
                    echo "<a href='./$run/ui/'>UI</a>"
                  fi
                  if [ ! -d "ghp/$run/api" ] && [ ! -d "ghp/$run/ui" ]; then
                    echo "<a href='./$run/'>Legacy Report (Flat)</a>"
                  fi
                  
                  echo "  </div>"
                  echo "</div>"
              done)
              </div>
            </div>
          </body>
          </html>
          EOF
      
          touch ghp/.nojekyll

      # =========================================================
      # Publish gh-pages
      # =========================================================
      - name: Publish gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ghp
          keep_files: true

      # =========================================================
      # Job Summary (Markdown for GitHub)
      # =========================================================
      - name: Job Summary
        if: always()
        run: |
          BASE="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

          {
            echo "## Allure Reports"
            echo "- [API Report](${BASE}/latest/api/)"
            echo "- [UI Report](${BASE}/latest/ui/)"
            echo ""

            echo "### API Severe Failures"
            echo "| Severity | Test |"
            echo "|---|---|"
            jq -r --arg block "${API_BLOCK_SEVERITIES}" '
              ( $block | split(",") ) as $sevlist
              | select(.status=="failed" or .status=="broken")
              | (.labels // [] | map(select(.name=="severity") | .value | ascii_downcase) | .[0]) as $sev
              | select($sev != null and ($sevlist | index($sev)))
              | "| \($sev) | \(.name // .fullName) |"
            ' e2e/api-automation/target/allure-results/*.json 2>/dev/null || echo "| â€” | â€” |"

            echo ""
            echo "### UI Severe Failures"
            echo "| Severity | Test |"
            echo "|---|---|"
            jq -r --arg block "${UI_BLOCK_SEVERITIES}" '
              ( $block | split(",") ) as $sevlist
              | select(.status=="failed" or .status=="broken")
              | (.labels // [] | map(select(.name=="severity") | .value | ascii_downcase) | .[0]) as $sev
              | select($sev != null and ($sevlist | index($sev)))
              | "| \($sev) | \(.name // .fullName) |"
            ' e2e/ui-automation/target/allure-results/*.json 2>/dev/null || echo "| â€” | â€” |"
          } >> "$GITHUB_STEP_SUMMARY"

      # =========================================================
      # FINAL PR GATE
      # =========================================================
      - name: Final PR Gate
        if: always()
        run: |
          API_BLOCK=$(jq -r --arg block "${API_BLOCK_SEVERITIES}" '( $block | split(",") ) as $sevlist | select(.status=="failed" or .status=="broken") | (.labels[]? | select(.name=="severity") | .value | ascii_downcase) as $sev | select($sevlist | index($sev))' e2e/api-automation/target/allure-results/*.json 2>/dev/null | wc -l)
          UI_BLOCK=$(jq -r --arg block "${UI_BLOCK_SEVERITIES}" '( $block | split(",") ) as $sevlist | select(.status=="failed" or .status=="broken") | (.labels[]? | select(.name=="severity") | .value | ascii_downcase) as $sev | select($sevlist | index($sev))' e2e/ui-automation/target/allure-results/*.json 2>/dev/null | wc -l)

          if [ "$API_BLOCK" -gt 0 ] || [ "$UI_BLOCK" -gt 0 ]; then
            echo "::error::Blocking severe failures detected ($API_BLOCK API, $UI_BLOCK UI)"
            exit 1
          fi
